<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFA Calculation Results with Limits</title>
    <link rel="stylesheet" href="./css/CFACSS.css">
    <script src="./lib/chart.js/Chart.min.js"></script>
    
</head>
<body>

    <h1>
        <img src="./Img/FPALogo.png" alt="logo" style="height:50px; vertical-align:middle; margin-right:10px;">
        CFA Calculation Results
    </h1>

    <div>
        <label for="auditInput"><strong>Enter Audit ID:</strong></label>
        <input type="text" id="auditInput" placeholder="e.g. 1461">
        <button onclick="loadResults()" id="loadBtn">Load Data</button>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner">
            <img src="./Img/FPALogo.png" alt="logo">
            <p style="color:white; font-weight:bold;">Processing... Please wait</p>
        </div>
    </div>

    <h2>Audit Results with Limits</h2>
    <table id="resultsTable"></table>

    <script>
        // Helper function for safe array access
        function safeArray(arr, index) {
            return (arr && arr.length > index) ? arr[index] : 0;
        }

        async function loadResults() {
            const auditId = document.getElementById("auditInput").value.trim();
            const overlay = document.getElementById("loadingOverlay");
            const btn = document.getElementById("loadBtn");

            if (!auditId) {
                alert("Please enter an Audit ID.");
                return;
            }

            overlay.style.display = "flex";
            btn.disabled = true;

            try {
                const response = await fetch(`./api/CFACal/RunFullCalculation?auditId=${auditId}`);
                if (!response.ok) throw new Error(`API returned ${response.status}`);
                const data = await response.json();

                // Use lowercase first letters for properties
                const classMapping = {
                    "TS_CFA_INWT": data.incomingWaterTemperature ?? 0,
                    "TS_CFA_FVFR": data.fvfr ?? 0,
                    "TS_CFA_FVOL": data.fillVolume ?? 0,
                    "TS_CFA_FT1": safeArray(data.timedFills, 0),
                    "TS_CFA_FT2": safeArray(data.timedFills, 1),
                    "TS_CFA_FT3": safeArray(data.timedFills, 2),
                    "TS_CFA_FT4": safeArray(data.timedFills, 3),
                    "TS_CFA_FT5": safeArray(data.timedFills, 4),
                    "TS_CFA_FF1": safeArray(data.finalFills, 0),
                    "TS_CFA_FF2": safeArray(data.finalFills, 1),
                    "TS_CFA_FF3": safeArray(data.finalFills, 2),
                    "TS_CFA_FF4": safeArray(data.finalFills, 3),
                    "TS_CFA_FF5": safeArray(data.finalFills, 4),
                    "TS_CFA_MWT": data.mainWashTemp ?? 0,
                    "TS_CFA_FNT": data.finalRinseTemp ?? 0,
                    "TS_CFA_ENER": data.energyKWh ?? 0,
                    "TS_CFA_HEATUP": data.heatUpRateCPerS ?? 0,
                    "TS_CFA_VOLT": data.voltage ?? 0,
                    "TS_CFA_MWA": data.mainWashAmperage ?? 0,
                    "TS_CFA_FRA": data.finalRinseAmperage ?? 0,
                    "TS_CFA_CTIME": data.cycleTime ?? 0
                };

                const table = document.getElementById("resultsTable");
                table.innerHTML = "";

                // Table header
                const header = table.insertRow();
                ["Part", "Class", "Description", "Lower Limit", "Actual", "Upper Limit"].forEach(text => {
                    const th = document.createElement("th");
                    th.textContent = text;
                    header.appendChild(th);
                });

                // Populate rows (taskReference removed)
                data.partLimits.forEach(item => {
                    const actualValue = classMapping[item.class] ?? 0;
                    const row = table.insertRow();

                    [
                        item.part ?? "-",
                        item.class ?? "-",
                        item.description ?? "-",
                        item.lowerLimit ?? "-",
                        actualValue,
                        item.upperLimit ?? "-"
                    ].forEach(val => {
                        const cell = row.insertCell();
                        cell.textContent = val;
                    });

                    if ((item.lowerLimit !== null && actualValue < item.lowerLimit) ||
                        (item.upperLimit !== null && actualValue > item.upperLimit)) {
                        row.style.backgroundColor = "#f8d7da";  // fail
                    } else {
                        row.style.backgroundColor = "#d4edda";  // pass
                    }
                });


            } catch (err) {
                console.error(err);
                alert("Failed to load results: " + err.message);
            } finally {
                overlay.style.display = "none";
                btn.disabled = false;
            }
        }

        document.getElementById("auditInput").addEventListener("keydown", e => {
            if (e.key === "Enter") loadResults();
        });
    </script>

</body>
</html>
