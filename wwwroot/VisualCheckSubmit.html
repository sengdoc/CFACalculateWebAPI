<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>BOM Visual Check with KPI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="css/CFACSS.css" rel="stylesheet" />
</head>
<body>
    <h1><img src="./Img/FPALogo.png" alt="logo"> BOM Visual Check</h1>

    <div class="product-card" role="region" aria-labelledby="prodHeader">
        <div>
            <div>
                <label for="serialInput"><strong>Serial No:</strong></label><br />
                <div class="serial-wrapper">
                    <input type="text" id="serialInput" placeholder="81370BUG777777" aria-describedby="serialHelp" />
                    <button id="copySerialBtn" title="Copy Serial No" aria-label="Copy Serial No">📋</button>
                </div>
                <!--<div id="serialHelp" style="font-size:0.9em;color:#666">Enter at least 10 characters or press Enter to load</div>-->
                <div id="copyFeedback" class="copy-feedback" role="status" aria-live="polite">Copied!</div>
            </div>
            <div>
                <label for="taskInput"><strong>Task:</strong></label><br />
                <div class="select-wrapper">
                    <select id="taskInput" aria-label="Task selection">
                        <option value="3570">3570</option>
                        <option value="4625">4625</option>
                    </select>
                </div>
            </div>
            <div>
                <button class="select-wrapper" id="loadBtn" title="Load Results" aria-label="Load Results">🔄</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" aria-hidden="true">
        <div class="spinner" role="status" aria-live="polite">
            <img src="./Img/FPALogo.png" alt="Loading..." />
        </div>
    </div>

    <div class="kpi-row" id="kpiContainer" role="status" aria-live="polite"></div>

    <div class="card">
        <h3>Visual Check</h3>
        <table id="visualCheckTable" aria-describedby="visualDesc" style="text-align: left;">
            <caption id="visualDesc" style="display:none">Parts visual checks and results</caption>
            <thead>
                <tr><th>P/N</th><th>Description</th><th>Result</th><th>Comment</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <button id="saveResultTestBtn" disabled>Save Result Test</button>

    <script>
        const API_BASE = "./api/CFACal";
        let lastData = { vVisualChecks: [] };
        const timeoutMs = 15000;

        const serialInput = document.getElementById("serialInput");
        const taskInput = document.getElementById("taskInput");
        const loadBtn = document.getElementById("loadBtn");
        const saveBtn = document.getElementById("saveResultTestBtn");
        const copySerialBtn = document.getElementById("copySerialBtn");
        const copyFeedback = document.getElementById("copyFeedback");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const kpiContainer = document.getElementById("kpiContainer");
        const tableBody = document.querySelector("#visualCheckTable tbody");

        function showLoading(show) {
            loadingOverlay.style.display = show ? "flex" : "none";
            loadingOverlay.setAttribute("aria-hidden", show ? "false" : "true");
            loadBtn.disabled = show;
            saveBtn.disabled = show || lastData.vVisualChecks.length === 0;
        }

        function copySerialNo() {
            const serial = serialInput.value.trim();
            if (!serial || serial.length < 5) {
                alert("Serial No is empty or invalid");
                return;
            }

            const serialNo = serial.substring(5); // Extract Serial No part

            navigator.clipboard.writeText(serialNo).then(() => {
                copyFeedback.classList.add("show");
                setTimeout(() => {
                    copyFeedback.classList.remove("show");
                }, 2000);
            }).catch(() => {
                alert("Failed to copy Serial No");
            });
        }

        async function fetchWithTimeout(url, opts = {}, ms = timeoutMs) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), ms);
            try {
                opts.signal = controller.signal;
                const r = await fetch(url, opts);
                clearTimeout(id);
                return r;
            } catch (err) {
                clearTimeout(id);
                throw err;
            }
        }

        async function loadBOMVisual() {
            const serial = serialInput.value.trim();
            const task = taskInput.value;
            if (serial.length < 10) { alert("Invalid Serial No (must be at least 14 chars)"); serialInput.focus(); return; }

            const CA = serial.substring(0, 5);
            const SerialNo = serial.substring(5);

            showLoading(true);
            try {
                const resp = await fetchWithTimeout(`${API_BASE}/GETBOMTest?CA=${encodeURIComponent(CA)}&SerialNo=${encodeURIComponent(SerialNo)}&Task=${encodeURIComponent(task)}`);
                if (!resp.ok) throw new Error(`Server returned ${resp.status}`);
                const data = await resp.json();
                lastData.vVisualChecks = Array.isArray(data.vVisualChecks) ? data.vVisualChecks : [];
                renderVisualCheck();
                if (lastData.vVisualChecks.length === 0) alert("No visual checks returned for this serial/task.");
            } catch (err) {
                console.error(err);
                if (err.name === 'AbortError') alert("Request timed out. Try again.");
                else alert("Failed to load BOM visual check");
            } finally {
                showLoading(false);
                saveBtn.disabled = lastData.vVisualChecks.length === 0;
            }
        }

        function updateKPICount() {
            const total = lastData.vVisualChecks.length;
            let pass = 0, fail = 0;
            lastData.vVisualChecks.forEach(item => {
                if (item.test_tag === 'VSCHK') {
                    // FIX: cannot increment a ternary result — use explicit if/else
                    if (item.result === "OK") pass++;
                    else fail++;
                } else {
                    const val = parseFloat(item.result);
                    if (!isNaN(val) && item.lowerLimit != null && item.upperLimit != null && val >= item.lowerLimit && val <= item.upperLimit) pass++;
                    else fail++;
                }
            });

            kpiContainer.innerHTML = `
                            <div class="kpi-box">Total<div class="kpi-value">${total}</div></div>
                            <div class="kpi-box kpi-pass">Pass<div class="kpi-value">${pass}</div></div>
                            <div class="kpi-box kpi-fail">Fail<div class="kpi-value">${fail}</div></div>
                        `;
        }

        // Event delegation for results and comments
        function renderVisualCheck() {
            tableBody.innerHTML = "";

            lastData.vVisualChecks.forEach((item, idx) => {
                const tr = document.createElement("tr");
                tr.dataset.index = idx;

                const pnTd = document.createElement("td"); pnTd.textContent = item.part ?? "";
                const descTd = document.createElement("td"); descTd.textContent = item.description ?? "";
                const resTd = document.createElement("td");
                const commTd = document.createElement("td");

                // comment input
                const commentInput = document.createElement("input");
                commentInput.type = "text";
                commentInput.className = "vc-comment";
                commentInput.placeholder = "Key comment here";
                commentInput.value = item.comment ?? "";
                commentInput.addEventListener("input", (e) => {
                    lastData.vVisualChecks[idx].comment = e.target.value;
                });
                commTd.appendChild(commentInput);

                if (item.test_tag === 'LMCHK') {
                    const wrapper = document.createElement("div");
                    wrapper.className = "result-wrapper";

                    const input = document.createElement("input");
                    input.type = "text";
                    input.className = "result-input";
                    input.value = item.result ?? "";
                    input.setAttribute("aria-label", `Limit check for ${item.part ?? idx}`);
                    input.addEventListener("input", (e) => {
                        const v = e.target.value.trim();
                        lastData.vVisualChecks[idx].result = v;
                        const val = parseFloat(v);
                        if (!isNaN(val) && item.lowerLimit != null && item.upperLimit != null) {
                            e.target.style.backgroundColor = (val >= item.lowerLimit && val <= item.upperLimit) ? "#d4edda" : "#f8d7da";
                        } else {
                            e.target.style.backgroundColor = "white";
                        }
                        updateKPICount();
                    });

                    const limits = document.createElement("span");
                    limits.textContent = `[${item.lowerLimit ?? "-"} - ${item.upperLimit ?? "-"}]`;
                    wrapper.appendChild(input);
                    wrapper.appendChild(limits);
                    resTd.appendChild(wrapper);
                } else if (item.test_tag === 'VSCHK') {
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.checked = item.result === "OK";
                    checkbox.setAttribute("aria-label", `Visual check for ${item.part ?? idx}`);
                    checkbox.addEventListener("change", (e) => {
                        lastData.vVisualChecks[idx].result = e.target.checked ? "OK" : "NG";
                        updateKPICount();
                    });

                    // Make cell clickable to toggle (but preserve checkbox click)
                    resTd.addEventListener("click", (e) => {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                            lastData.vVisualChecks[idx].result = checkbox.checked ? "OK" : "NG";
                            updateKPICount();
                        }
                    });

                    resTd.appendChild(checkbox);
                } else {
                    // fallback: text input for unknown tag
                    const input = document.createElement("input");
                    input.type = "text";
                    input.className = "result-input";
                    input.value = item.result ?? "";
                    input.addEventListener("input", (e) => {
                        lastData.vVisualChecks[idx].result = e.target.value;
                        updateKPICount();
                    });
                    resTd.appendChild(input);
                }

                tr.appendChild(pnTd);
                tr.appendChild(descTd);
                tr.appendChild(resTd);
                tr.appendChild(commTd);
                tableBody.appendChild(tr);
            });

            updateKPICount();
            saveBtn.disabled = lastData.vVisualChecks.length === 0;
        }

        async function saveResults() {
            const serial = serialInput.value.trim();
            const task = taskInput.value.trim();
            if (!serial || !task) { alert("Serial No and Task are required."); return; }
            if (lastData.vVisualChecks.length === 0) { alert("No results to save."); return; }

            const CA = serial.substring(0, 5);
            const SerialNo = serial.substring(5);

            const visualData = lastData.vVisualChecks.map(item => {
                const resultStr = item.result ?? "";
                const isVs = item.test_tag === 'VSCHK';
                const passed = isVs
                    ? (resultStr === "OK")
                    : (!isNaN(resultStr) && item.lowerLimit != null && item.upperLimit != null && parseFloat(resultStr) >= item.lowerLimit && parseFloat(resultStr) <= item.upperLimit);
                return {
                    PartNo: item.part,
                    ResultValue: resultStr,
                    tstStatus: passed ? "P" : "F",
                    Comment: item.comment ?? ""
                };
            });

            const payload = {
                CA,
                SerialNo,
                Task: task,
                vVisualResults: visualData,
                TypeInput: 'VSCHK'
            };

            showLoading(true);
            try {
                const resp = await fetchWithTimeout(`${API_BASE}/SaveResultTest`, {
                    method: 'POST',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const resJson = await resp.json().catch(() => ({}));
                if (resp.ok) {
                    alert(resJson.message || "Result saved successfully");
                } else {
                    alert(resJson.message || `Error saving result (status ${resp.status})`);
                }
            } catch (err) {
                console.error(err);
                if (err.name === 'AbortError') alert("Save request timed out.");
                else alert("Error saving result");
            } finally {
                showLoading(false);
            }
        }

        // Event wiring
        loadBtn.addEventListener("click", () => loadBOMVisual());
        saveBtn.addEventListener("click", () => saveResults());
        copySerialBtn.addEventListener("click", () => copySerialNo());

        // Allow Enter to trigger load
        serialInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                loadBOMVisual();
            }
        });

        // Basic paste sanitization: trim input
        serialInput.addEventListener("paste", (e) => {
            setTimeout(() => serialInput.value = serialInput.value.trim(), 0);
        });
    </script>
</body>
</html>